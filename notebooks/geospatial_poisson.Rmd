---
title: "Analyzing Aggravated Burglaries in Davidson County"
output: html_notebook
---

**Part 1 - Data Preparation**

You've been provided three datasets for this project:
  - burglaries_2023.csv: Contains data on the aggravated burglary incidents in Davidson County. This was obtained from https://data.nashville.gov/Police/Metro-Nashville-Police-Department-Incidents/2u6v-ujjs.
  - census.csv: Census tract level data on population and median income. This was obtained from the US Census American Community Survey.
  - DC: A shapefile containing Davidson County census tracts

Perform a spatial join to determine the census tract in which each burglary occurred. Hint: You may want to make use of the st_as_sf function in order to convert the burglaries data into an sf object.

After performing the spatial join, merge in the census data. Note: Make sure that the final dataset contains all census tracts.

```{r}
library(tidyverse)
library(sf)
library(leaflet)
library(lubridate)
```

1. Read the three datasets. 

```{r}
burglaries_2023 <- read_csv('../data/burglaries_2023.csv')
```
```{r}
census <- read_csv('../data/census.csv')
```

```{r}
davidson_tracts <- st_read('../data/DC/DC.shp')
```

```{r}
davidson_tracts |> 
  ggplot() + 
  geom_sf()
```

Note: Remove the two events that occurred beyond Davidson County (latitude < 34.5, longitude > 92). Initially, the original burglaries data (burglaries_2023) contained 1146 rows. 

```{r}
burglaries_2023 <- burglaries_2023 |> 
  filter(!(latitude < 34.5))
```

2. Perform a spatial join to determine the census tract in which each burglary occurred.But first, use the st_as_sf function in order to convert the burglaries data into an sf object.

```{r}
burglaries_geo <- st_as_sf(burglaries_2023 |> drop_na(latitude), 
                           coords = c('longitude', 'latitude'),
                           crs = st_crs(davidson_tracts)
                           )
```

Plot the Davidson County tracts with the burglary (sf) data. 
```{r}
davidson_tracts |> 
  ggplot() + 
  geom_sf() + 
  geom_sf(data = burglaries_geo, size = 0.2)
```

Perform a spatial join using st_join function. 
```{r}
burglaries_tracts <- st_join(burglaries_geo, davidson_tracts, join = st_within)
```

3. After performing the spatial join, merge in the census data. Note: Make sure that the final dataset contains all census tracts.

Note: Before merging, clean up census df. Rename 'tract' column in census df to 'TRACTCE'. Remove other columns that currently exist in burglaries_tracts df. 
```{r}
census <- census |> 
  select(TRACTCE = tract, POPULATION = population, 'MEDIAN INCOME' = median_income)

burglaries_tracts <- merge(burglaries_tracts, census, by = 'TRACTCE')
```

Census dataframe with geometry: 
```{r}
tract_info <- merge(census, davidson_tracts, by = 'TRACTCE')

tract_info <- tract_info |> 
  select(TRACTCE, POPULATION, `MEDIAN INCOME`, GEOMETRY = geometry)

tract_info <- st_as_sf(tract_info)
```


**Part 2 - Exploratory Analysis** 

Perform some exploratory analysis on your prepared dataset.

Check the unique values in TRACTCE column in burglaries_tracts. 
```{r}
n_distinct(burglaries_tracts$TRACTCE)
```

1. Aggregate the data by census tract. Warning: each incident can appear multiple times if there are multiple victims, so be sure that you aren't double-counting any incidents.

```{r}
burglaries_tracts <- burglaries_tracts |> 
  distinct(incident_number, .keep_all = TRUE)
```

Which census tract had the highest number of burglaries? 

```{r}
burglaries_tracts |> 
  st_drop_geometry() |>
  group_by(TRACTCE) |> 
  summarise(Count = n_distinct(incident_number)) |> 
  arrange(desc(Count)) |> 
  head(1)
```

Which census tract had the highest number of burglaries per 1000 residents?

Example df with summarize using original columns:
```{r}
burglaries_tracts |> 
  st_drop_geometry() |>
  group_by(TRACTCE) |> 
  summarise(Count = n_distinct(incident_number), Population = first(POPULATION), Count_Per_1000Pop = n_distinct(incident_number)/(first(POPULATION)/1000)) |> 
  filter(Population > 0) |>
  arrange(desc(Count_Per_1000Pop)) |> 
  head(1)
```

This uses columns from summarize df: 
```{r}
burglaries_tracts |> 
  st_drop_geometry() |>
  group_by(TRACTCE) |> 
  summarise(Count = n_distinct(incident_number), Population = first(POPULATION), Count_Per_1000Pop = Count/(Population/ 1000)) |> 
  filter(Population > 0) |> 
  arrange(desc(Count_Per_1000Pop)) |> 
  head(1)
```

```{r}
burglaries_tracts |> 
  group_by(TRACTCE) |> 
  summarise(Count = n_distinct(incident_number), Population = first(POPULATION), Count_Per_1000Pop = Count/(Population/ 1000)) |> 
  filter(Population > 0) |> 
  arrange(desc(Count_Per_1000Pop)) |> 
  head(10) |> 
  ggplot(aes(x = TRACTCE, y = Count_Per_1000Pop, fill = TRACTCE)) + geom_col() + 
  ggtitle("Top Ten Tracts in Davidson County With High Burglary Count")
```


```{r}
population_summary <- burglaries_tracts |> 
  group_by(TRACTCE) |> 
  summarise(Count = n_distinct(incident_number), Population = first(POPULATION), Count_Per_1000Pop = Count/(Population/ 1000)) |> 
  filter(Population > 0) |> 
  arrange(desc(Count_Per_1000Pop))
  
ggplot() + 
  geom_sf(data = davidson_tracts) +
  geom_sf(data = population_summary, aes(color = Count_Per_1000Pop)) + 
  scale_color_gradient(low = "blue", high = "red")
```

```{r}
ggplot() + 
  geom_sf(data = davidson_tracts) +
  geom_sf(data = population_summary, aes(color = Count)) + 
  scale_color_viridis_b() + 
  ggtitle("2023 Burglary Data in Davidson County")
```

We're interested in the relationship between median income and number of aggravated burglaries, so examine those variables on their own and together to see what you can find. You may want to perform additional calculations, create plots, etc.

```{r}

```


NOTE: 
Removed Tracts 980100 and 980200 because they don't have geometry, population, or median income information. 

```{r}
burglaries_tracts <- burglaries_tracts |> 
  filter(!(TRACTCE == 980100 | TRACTCE == 980200))
```

How does the median income compare throughout all tracts in Davidson County? 
```{r}
burglaries_tracts |> 
  st_drop_geometry() |> 
  summarise(Mean = mean(`MEDIAN INCOME`), Median = median(`MEDIAN INCOME`), Min = min(`MEDIAN INCOME`), Max = max(`MEDIAN INCOME`))
```

```{r}
ggplot() + 
  geom_sf(data = davidson_tracts) + 
  geom_sf(data = tract_info, aes(fill = `MEDIAN INCOME`))
```


```{r}
burglaries_unique |> 
  st_drop_geometry() |> 
  filter(!(TRACTCE == 980100 | TRACTCE == 980200))
```


What month do most burglaries occur in 2023? 

group_by(month) |> 
summarise(total_cases = sum(incident_number))

```{r}
burglaries_unique <- burglaries_unique |> 
  mutate(
    Month = month(incident_occurred)
  )
```
```{r}
str(burglaries_unique)
```

Out of the week, what day do most burglaries occur in 2023? 

```{r}

```

